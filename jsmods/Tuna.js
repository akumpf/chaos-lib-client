/*
    Copyright (c) 2012 DinahMoe AB

    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy,
    modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software
    is furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
    DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE
    OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*///Originally written by Alessandro Saccoia, Chris Coniglio and Oskar Eriksson
(function(e){function p(e){return Math.max(0,Math.round(100*Math.pow(2,e/6))/100)}function d(e,t){var n,r,i=0,s=0,o=0,u=0;return n=e.toExponential().match(/^.\.?(.*)e(.+)$/),i=parseInt(n[2],10)-(n[1]+"").length,n=t.toExponential().match(/^.\.?(.*)e(.+)$/),s=parseInt(n[2],10)-(n[1]+"").length,s>i&&(i=s),r=e%t,i<-100||i>20?(o=Math.round(Math.log(r)/Math.log(10)),u=Math.pow(10,o),(r/u).toFixed(o-i)*u):parseFloat(r.toFixed(-i))}function v(e){return e===0?1:Math.abs(e)/e}function m(e){return(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}var t,n,r=function(r){r||(console.log("tuna.js: Missing audio context! Creating a new context for you."),r=e.webkitAudioContext&&new e.webkitAudioContext),t=r,n=this},i="0.1",s="setValueAtTime",o="linearRampToValueAtTime",u=function(e,t){e.value=t},a=Object.create(null,{activate:{writable:!0,value:function(e){e?(this.input.disconnect(),this.input.connect(this.activateNode),this.activateCallback&&this.activateCallback(e)):(this.input.disconnect(),this.input.connect(this.output))}},bypass:{get:function(){return this._bypass},set:function(e){if(this._lastBypassValue===e)return;this._bypass=e,this.activate(!e),this._lastBypassValue=e}},connect:{value:function(e){this.output.connect(e)}},disconnect:{value:function(e){this.output.disconnect(e)}},connectInOrder:{value:function(e){var t=e.length-1;while(t--){if(!e[t].connect)return console.error("AudioNode.connectInOrder: TypeError: Not an AudioNode.",e[t]);e[t+1].input?e[t].connect(e[t+1].input):e[t].connect(e[t+1])}}},getDefaults:{value:function(){var e={};for(var t in this.defaults)e[t]=this.defaults[t].value;return e}},automate:{value:function(e,n,r,i){var u=i?~~(i/1e3):t.currentTime,a=r?~~(r/1e3):0,f=this.defaults[e],l=this[e],c;l?f.automatable?(r?(c=o,l.cancelScheduledValues(u),l.setValueAtTime(l.value,u)):c=s,l[c](n,a+u)):l=n:console.error("Invalid Property for "+this.name)}}}),f="float",l="boolean",c="string",h="int";r.prototype.Filter=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.activateNode=t.createGainNode(),this.filter=t.createBiquadFilter(),this.output=t.createGainNode(),this.activateNode.connect(this.filter),this.filter.connect(this.output),this.frequency=e.frequency||this.defaults.frequency.value,this.Q=e.resonance||this.defaults.Q.value,this.filterType=e.filterType||this.defaults.filterType.value,this.gain=e.gain||this.defaults.gain.value,this.bypass=!1},r.prototype.Filter.prototype=Object.create(a,{name:{value:"Filter"},defaults:{writable:!0,value:{frequency:{value:800,min:20,max:22050,automatable:!0,type:f},Q:{value:1,min:.001,max:100,automatable:!0,type:f},gain:{value:0,min:-40,max:40,automatable:!0,type:f},bypass:{value:!0,automatable:!1,type:l},filterType:{value:1,min:0,max:7,automatable:!1,type:h}}},filterType:{enumerable:!0,get:function(){return this.filter.type},set:function(e){this.filter.type=e}},Q:{enumerable:!0,get:function(){return this.filter.Q},set:function(e){this.filter.Q.value=e}},gain:{enumerable:!0,get:function(){return this.filter.gain},set:function(e){this.filter.gain.value=e}},frequency:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.value=e}}}),r.prototype.Cabinet=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.activateNode=t.createGainNode(),this.convolver=this.newConvolver(e.impulsePath||"../impulses/impulse_guitar.wav"),this.makeupNode=t.createGainNode(),this.output=t.createGainNode(),this.activateNode.connect(this.convolver.input),this.convolver.output.connect(this.makeupNode),this.makeupNode.connect(this.output),this.makeupGain=e.makeupGain||this.defaults.makeupGain,this.bypass=!1},r.prototype.Cabinet.prototype=Object.create(a,{name:{value:"Cabinet"},defaults:{writable:!0,value:{makeupGain:{value:1,min:0,max:20,automatable:!0,type:f},bypass:{value:!1,automatable:!1,type:l}}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.value=e}},newConvolver:{value:function(e){return new n.Convolver({impulse:e,dryLevel:0,wetLevel:1})}}}),r.prototype.Chorus=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.attenuator=this.activateNode=t.createGainNode(),this.splitter=t.createChannelSplitter(2),this.delayL=t.createDelayNode(),this.delayR=t.createDelayNode(),this.feedbackGainNodeLR=t.createGainNode(),this.feedbackGainNodeRL=t.createGainNode(),this.merger=t.createChannelMerger(2),this.output=t.createGainNode(),this.lfoL=new n.LFO({target:this.delayL.delayTime,callback:u}),this.lfoR=new n.LFO({target:this.delayR.delayTime,callback:u}),this.input.connect(this.attenuator),this.attenuator.connect(this.output),this.attenuator.connect(this.splitter),this.splitter.connect(this.delayL,0),this.splitter.connect(this.delayR,1),this.delayL.connect(this.feedbackGainNodeLR),this.delayR.connect(this.feedbackGainNodeRL),this.feedbackGainNodeLR.connect(this.delayR),this.feedbackGainNodeRL.connect(this.delayL),this.delayL.connect(this.merger,0,0),this.delayR.connect(this.merger,0,1),this.merger.connect(this.output),this.feedback=e.feedback||this.defaults.feedback.value,this.rate=e.rate||this.defaults.rate.value,this.delay=e.delay||this.defaults.delay.value,this.depth=e.depth||this.defaults.depth.value,this.lfoR.phase=Math.PI/2,this.attenuator.gain.value=.6934,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=!1},r.prototype.Chorus.prototype=Object.create(a,{name:{value:"Chorus"},defaults:{writable:!0,value:{feedback:{value:.4,min:0,max:.95,automatable:!1,type:f},delay:{value:.0045,min:0,max:1,automatable:!1,type:f},depth:{value:.7,min:0,max:1,automatable:!1,type:f},rate:{value:1.5,min:0,max:8,automatable:!1,type:f},bypass:{value:!0,automatable:!1,type:l}}},delay:{enumerable:!0,get:function(){return this._delay},set:function(e){this._delay=2e-4*Math.pow(10,e)*2,this.lfoL.offset=this._delay,this.lfoR.offset=this._delay,this._depth=this._depth}},depth:{enumerable:!0,get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._depth*this._delay,this.lfoR.oscillation=this._depth*this._delay}},feedback:{enumerable:!0,get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeLR.gain.value=this._feedback,this.feedbackGainNodeRL.gain.value=this._feedback}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}}}),r.prototype.Compressor=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.compNode=this.activateNode=t.createDynamicsCompressor(),this.makeupNode=t.createGainNode(),this.output=t.createGainNode(),this.compNode.connect(this.makeupNode),this.makeupNode.connect(this.output),this.automakeup=e.automakeup||this.defaults.automakeup.value,this.makeupGain=e.makeupGain||this.defaults.makeupGain.value,this.threshold=e.threshold||this.defaults.threshold.value,this.release=e.release||this.defaults.release.value,this.attack=e.attack||this.defaults.attack.value,this.ratio=e.ratio||this.defaults.ratio.value,this.knee=e.knee||this.defaults.knee.value,this.bypass=!1},r.prototype.Compressor.prototype=Object.create(a,{name:{value:"Compressor"},defaults:{writable:!0,value:{threshold:{value:-20,min:-60,max:0,automatable:!0,type:f},release:{value:250,min:10,max:2e3,automatable:!0,type:f},makeupGain:{value:1,min:1,max:100,automatable:!0,type:f},attack:{value:1,min:0,max:1e3,automatable:!0,type:f},ratio:{value:4,min:1,max:50,automatable:!0,type:f},knee:{value:5,min:0,max:40,automatable:!0,type:f},automakeup:{value:!1,automatable:!1,type:l},bypass:{value:!0,automatable:!1,type:l}}},computeMakeup:{value:function(){var e=4,t=this.compNode;return-(t.threshold.value-t.threshold.value/t.ratio.value)/e}},automakeup:{enumerable:!0,get:function(){return this._automakeup},set:function(e){this._automakeup=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},threshold:{enumerable:!0,get:function(){return this.compNode.threshold},set:function(e){this.compNode.threshold.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},ratio:{enumerable:!0,get:function(){return this.compNode.ratio},set:function(e){this.compNode.ratio.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},knee:{enumerable:!0,get:function(){return this.compNode.knee},set:function(e){this.compNode.knee.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},attack:{enumerable:!0,get:function(){return this.compNode.attack},set:function(e){this.compNode.attack.value=e/1e3}},release:{enumerable:!0,get:function(){return this.compNode.release},set:function(e){this.compNode.release=e/1e3}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.value=p(e)}}}),r.prototype.Convolver=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.activateNode=t.createGainNode(),this.convolver=t.createConvolver(),this.dry=t.createGainNode(),this.filterLow=t.createBiquadFilter(),this.filterHigh=t.createBiquadFilter(),this.wet=t.createGainNode(),this.output=t.createGainNode(),this.activateNode.connect(this.filterLow),this.activateNode.connect(this.dry),this.filterLow.connect(this.filterHigh),this.filterHigh.connect(this.convolver),this.convolver.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.dryLevel=e.dryLevel||this.defaults.dryLevel.value,this.wetLevel=e.wetLevel||this.defaults.wetLevel.value,this.highCut=e.highCut||this.defaults.highCut.value,this.buffer=e.impulse||"../impulses/ir_rev_short.wav",this.lowCut=e.lowCut||this.defaults.lowCut.value,this.level=e.level||this.defaults.level.value,this.filterHigh.type=0,this.filterLow.type=1,this.bypass=!1},r.prototype.Convolver.prototype=Object.create(a,{name:{value:"Convolver"},defaults:{writable:!0,value:{highCut:{value:22050,min:20,max:22050,automatable:!0,type:f},lowCut:{value:20,min:20,max:22050,automatable:!0,type:f},dryLevel:{value:1,min:0,max:1,automatable:!0,type:f},wetLevel:{value:1,min:0,max:1,automatable:!0,type:f},level:{value:1,min:0,max:1,automatable:!0,type:f}}},lowCut:{get:function(){return this.filterLow.frequency},set:function(e){this.filterLow.frequency.value=e}},highCut:{get:function(){return this.filterHigh.frequency},set:function(e){this.filterHigh.frequency.value=e}},level:{get:function(){return this.output.gain},set:function(e){this.output.gain.value=e}},dryLevel:{get:function(){return this.dry.gain},set:function(e){this.dry.gain.value=e}},wetLevel:{get:function(){return this.wet.gain},set:function(e){this.wet.gain.value=e}},buffer:{enumerable:!1,get:function(){return this.convolver.buffer},set:function(e){var n=this.convolver,r=new XMLHttpRequest;if(!e){console.log("Tuna.Convolver.setBuffer: Missing impulse path!");return}r.open("GET",e,!0),r.responseType="arraybuffer",r.onreadystatechange=function(){r.readyState===4&&(r.status<300&&r.status>199||r.status===302)&&t.decodeAudioData(r.response,function(e){n.buffer=e},function(e){e&&console.log("Tuna.Convolver.setBuffer: Error decoding data"+e)})},r.send(null)}}}),r.prototype.Delay=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.activateNode=t.createGainNode(),this.dry=t.createGainNode(),this.wet=t.createGainNode(),this.filter=t.createBiquadFilter(),this.delay=t.createDelayNode(),this.feedbackNode=t.createGainNode(),this.output=t.createGainNode(),this.activateNode.connect(this.delay),this.activateNode.connect(this.dry),this.delay.connect(this.filter),this.filter.connect(this.feedbackNode),this.feedbackNode.connect(this.delay),this.feedbackNode.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.delayTime=e.delayTime||this.defaults.delayTime.value,this.feedback=e.feedback||this.defaults.feedback.value,this.wetLevel=e.wetLevel||this.defaults.wetLevel.value,this.dryLevel=e.dryLevel||this.defaults.dryLevel.value,this.cutoff=e.cutoff||this.defaults.cutoff.value,this.filter.type=0,this.bypass=!1},r.prototype.Delay.prototype=Object.create(a,{name:{value:"Delay"},defaults:{writable:!0,value:{delayTime:{value:100,min:20,max:1e3,automatable:!1,type:f},feedback:{value:.45,min:0,max:.9,automatable:!0,type:f},cutoff:{value:2e4,min:20,max:2e4,automatable:!0,type:f},wetLevel:{value:.5,min:0,max:1,automatable:!0,type:f},dryLevel:{value:1,min:0,max:1,automatable:!0,type:f}}},delayTime:{enumerable:!0,get:function(){return this.delay.delayTime},set:function(e){this.delay.delayTime.value=e/1e3}},wetLevel:{enumerable:!0,get:function(){return this.wet.gain},set:function(e){this.wet.gain.value=e}},dryLevel:{enumerable:!0,get:function(){return this.dry.gain},set:function(e){this.dry.gain.value=e}},feedback:{enumerable:!0,get:function(){return this.feedbackNode.gain},set:function(e){this.feedbackNode.gain.value=e}},cutoff:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.value=e}}}),r.prototype.Overdrive=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.activateNode=t.createGainNode(),this.inputDrive=t.createGainNode(),this.waveshaper=t.createWaveShaper(),this.outputDrive=t.createGainNode(),this.output=t.createGainNode(),this.activateNode.connect(this.inputDrive),this.inputDrive.connect(this.waveshaper),this.waveshaper.connect(this.outputDrive),this.outputDrive.connect(this.output),this.ws_table=new Float32Array(this.k_nSamples),this.drive=e.drive||this.defaults.drive.value,this.outputGain=e.outputGain||this.defaults.outputGain.value,this.curveAmount=e.curveAmount||this.defaults.curveAmount.value,this.algorithmIndex=e.algorithmIndex||this.defaults.algorithmIndex.value,this.bypass=!1},r.prototype.Overdrive.prototype=Object.create(a,{name:{value:"Overdrive"},defaults:{writable:!0,value:{drive:{value:1,min:0,max:1,automatable:!0,type:f,scaled:!0},outputGain:{value:1,min:0,max:1,automatable:!0,type:f,scaled:!0},curveAmount:{value:.725,min:0,max:1,automatable:!1,type:f},algorithmIndex:{value:0,min:0,max:5,automatable:!1,type:h}}},k_nSamples:{value:8192},drive:{get:function(){return this.inputDrive.gain},set:function(e){this._drive=e}},curveAmount:{get:function(){return this._curveAmount},set:function(e){this._curveAmount=e,this._algorithmIndex===undefined&&(this._algorithmIndex=0),this.waveshaperAlgorithms[this._algorithmIndex](this._curveAmount,this.k_nSamples,this.ws_table),this.waveshaper.curve=this.ws_table}},outputGain:{get:function(){return this.outputDrive.gain},set:function(e){this._outputGain=p(e)}},algorithmIndex:{get:function(){return this._algorithmIndex},set:function(e){this._algorithmIndex=e,this.curveAmount=this._curveAmount}},waveshaperAlgorithms:{value:[function(e,t,n){e=Math.min(e,.9999);var r=2*e/(1-e),i,s;for(i=0;i<t;i++)s=i*2/t-1,n[i]=(1+r)*s/(1+r*Math.abs(s))},function(e,t,n){var r,i,s;for(r=0;r<t;r++)i=r*2/t-1,s=(.5*Math.pow(i+1.4,2)-1)*s>=0?5.8:1.2,n[r]=m(s)},function(e,t,n){var r,i,s,o=1-e;for(r=0;r<t;r++)i=r*2/t-1,s=i<0?-Math.pow(Math.abs(i),o+.04):Math.pow(i,o),n[r]=m(s*2)},function(e,t,n){var r,i,s,o,u=1-e>.99?.99:1-e;for(r=0;r<t;r++)i=r*2/t-1,o=Math.abs(i),o<u?s=o:o>u?s=u+(o-u)/(1+Math.pow((o-u)/(1-u),2)):o>1&&(s=o),n[r]=v(i)*s*(1/((u+1)/2))},function(e,t,n){var r,i;for(r=0;r<t;r++)i=r*2/t-1,i<-0.08905?n[r]=-3/4*(1-Math.pow(1-(Math.abs(i)-.032857),12)+1/3*(Math.abs(i)-.032847))+.01:i>=-0.08905&&i<.320018?n[r]=-6.153*i*i+3.9375*i:n[r]=.630035},function(e,t,n){var r=2+Math.round(e*14),i=Math.round(Math.pow(2,r-1)),s,o;for(s=0;s<t;s++)o=s*2/t-1,n[s]=Math.round(o*i)/i}]}}),r.prototype.Phaser=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.splitter=this.activateNode=t.createChannelSplitter(2),this.filtersL=[],this.filtersR=[],this.feedbackGainNodeL=t.createGainNode(),this.feedbackGainNodeR=t.createGainNode(),this.merger=t.createChannelMerger(2),this.filteredSignal=t.createGainNode(),this.output=t.createGainNode(),this.lfoL=new n.LFO({target:this.filtersL,callback:this.callback}),this.lfoR=new n.LFO({target:this.filtersR,callback:this.callback});var r=this.stage;while(r--)this.filtersL[r]=t.createBiquadFilter(),this.filtersR[r]=t.createBiquadFilter(),this.filtersL[r].type=7,this.filtersR[r].type=7;this.input.connect(this.splitter),this.input.connect(this.output),this.splitter.connect(this.filtersL[0],0,0),this.splitter.connect(this.filtersR[0],1,0),this.connectInOrder(this.filtersL),this.connectInOrder(this.filtersR),this.filtersL[this.stage-1].connect(this.feedbackGainNodeL),this.filtersL[this.stage-1].connect(this.merger,0,0),this.filtersR[this.stage-1].connect(this.feedbackGainNodeR),this.filtersR[this.stage-1].connect(this.merger,0,1),this.feedbackGainNodeL.connect(this.filtersL[0]),this.feedbackGainNodeR.connect(this.filtersR[0]),this.merger.connect(this.output),this.rate=e.rate||this.defaults.rate.value,this.baseModulationFrequency=e.baseModulationFrequency||this.defaults.baseModulationFrequency.value,this.depth=e.depth||this.defaults.depth.value,this.feedback=e.feedback||this.defaults.feedback.value,this.stereoPhase=e.stereoPhase||this.defaults.stereoPhase.value,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=!1},r.prototype.Phaser.prototype=Object.create(a,{name:{value:"Phaser"},stage:{value:4},defaults:{writable:!0,value:{rate:{value:.1,min:0,max:8,automatable:!1,type:f},depth:{value:.6,min:0,max:1,automatable:!1,type:f},feedback:{value:.7,min:0,max:1,automatable:!1,type:f},stereoPhase:{value:40,min:0,max:180,automatable:!1,type:f},baseModulationFrequency:{value:700,min:500,max:1500,automatable:!1,type:f}}},callback:{value:function(e,t){for(var n=0;n<4;n++)e[n].frequency.value=t}},depth:{get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._baseModulationFrequency*this._depth,this.lfoR.oscillation=this._baseModulationFrequency*this._depth}},rate:{get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},baseModulationFrequency:{enumerable:!0,get:function(){return this._baseModulationFrequency},set:function(e){this._baseModulationFrequency=e,this.lfoL.offset=this._baseModulationFrequency,this.lfoR.offset=this._baseModulationFrequency,this._depth=this._depth}},feedback:{get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeL.gain.value=this._feedback,this.feedbackGainNodeR.gain.value=this._feedback}},stereoPhase:{get:function(){return this._stereoPhase},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=d(t,2*Math.PI),this.lfoR._phase=t}}}),r.prototype.Tremolo=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.splitter=this.activateNode=t.createChannelSplitter(2),this.amplitudeL=t.createGainNode(),this.amplitudeR=t.createGainNode(),this.merger=t.createChannelMerger(2),this.output=t.createGainNode(),this.lfoL=new n.LFO({target:this.amplitudeL.gain,callback:u}),this.lfoR=new n.LFO({target:this.amplitudeR.gain,callback:u}),this.input.connect(this.splitter),this.splitter.connect(this.amplitudeL,0),this.splitter.connect(this.amplitudeR,1),this.amplitudeL.connect(this.merger,0,0),this.amplitudeR.connect(this.merger,0,1),this.merger.connect(this.output),this.rate=e.rate||this.defaults.rate.value,this.intensity=e.intensity||this.defaults.intensity.value,this.stereoPhase=e.stereoPhase||this.defaults.stereoPhase.value,this.lfoL.offset=1-this.intensity/2,this.lfoR.offset=1-this.intensity/2,this.lfoL.phase=this.stereoPhase*Math.PI/180,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=!1},r.prototype.Tremolo.prototype=Object.create(a,{name:{value:"Tremolo"},defaults:{writable:!0,value:{intensity:{value:.3,min:0,max:1,automatable:!1,type:f},stereoPhase:{value:0,min:0,max:180,automatable:!1,type:f},rate:{value:5,min:.1,max:11,automatable:!1,type:f}}},intensity:{enumerable:!0,get:function(){return this._intensity},set:function(e){this._intensity=e,this.lfoL.offset=1-this._intensity/2,this.lfoR.offset=1-this._intensity/2,this.lfoL.oscillation=this._intensity,this.lfoR.oscillation=this._intensity}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},stereoPhase:{enumerable:!0,get:function(){return this._rate},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=d(t,2*Math.PI),this.lfoR.phase=t}}}),r.prototype.WahWah=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.activateNode=t.createGainNode(),this.envelopeFollower=new n.EnvelopeFollower({target:this,callback:function(e,t){e.sweep=t}}),this.filterBp=t.createBiquadFilter(),this.filterPeaking=t.createBiquadFilter(),this.output=t.createGainNode(),this.activateNode.connect(this.filterBp),this.filterBp.connect(this.filterPeaking),this.filterPeaking.connect(this.output),this.init(),this.automode=e.enableAutoMode||this.defaults.automode.value,this.resonance=e.resonance||this.defaults.resonance.value,this.sensitivity=e.sensitivity||this.defaults.sensitivity.value,this.baseFrequency=e.baseFrequency||this.defaults.baseFrequency.value,this.excursionOctaves=e.excursionOctaves||this.defaults.excursionOctaves.value,this.sweep=e.sweep||this.defaults.sweep.value,this.activateNode.gain.value=2,this.envelopeFollower.activate(!0),this.bypass=!1},r.prototype.WahWah.prototype=Object.create(a,{name:{value:"WahWah"},defaults:{writable:!0,value:{automode:{value:!0,automatable:!1,type:l},baseFrequency:{value:.5,min:0,max:1,automatable:!1,type:f},excursionOctaves:{value:2,min:1,max:6,automatable:!1,type:f},sweep:{value:.2,min:0,max:1,automatable:!1,type:f},resonance:{value:10,min:1,max:100,automatable:!1,type:f},sensitivity:{value:.5,min:-1,max:1,automatable:!1,type:f}}},activateCallback:{value:function(e){this.automode=e}},automode:{get:function(){return this._automode},set:function(e){this._automode=e,e?(this.activateNode.connect(this.envelopeFollower.input),this.envelopeFollower.activate(!0)):(this.envelopeFollower.activate(!1),this.activateNode.disconnect(),this.activateNode.connect(this.filterBp))}},sweep:{enumerable:!0,get:function(){return this._sweep.value},set:function(e){this._sweep=Math.pow(e>1?1:e<0?0:e,this._sensitivity),this.filterBp.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep,this.filterPeaking.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep}},baseFrequency:{enumerable:!0,get:function(){return this._baseFrequency},set:function(e){this._baseFrequency=50*Math.pow(10,e*2),this._excursionFrequency=Math.min(this.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.filterBp.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep,this.filterPeaking.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep}},excursionOctaves:{enumerable:!0,get:function(){return this._excursionOctaves},set:function(e){this._excursionOctaves=e,this._excursionFrequency=Math.min(this.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.filterBp.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep,this.filterPeaking.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep}},sensitivity:{enumerable:!0,get:function(){return this._sensitivity},set:function(e){this._sensitivity=Math.pow(10,e)}},resonance:{enumerable:!0,get:function(){return this._resonance},set:function(e){this._resonance=e,this.filterPeaking.Q=this._resonance}},init:{value:function(){this.output.gain.value=1,this.filterPeaking.type=5,this.filterBp.type=2,this.filterPeaking.frequency.value=100,this.filterPeaking.gain.value=20,this.filterPeaking.Q.value=5,this.filterBp.frequency.value=100,this.filterBp.Q.value=1,this.sampleRate=t.sampleRate}}}),r.prototype.EnvelopeFollower=function(e){e||(e=this.getDefaults()),this.input=t.createGainNode(),this.jsNode=this.output=t.createJavaScriptNode(this.buffersize,1,1),this.input.connect(this.output),this.attackTime=e.attackTime||this.defaults.attackTime.value,this.releaseTime=e.releaseTime||this.defaults.releaseTime.value,this._envelope=0,this.target=e.target||{},this.callback=e.callback||function(){}},r.prototype.EnvelopeFollower.prototype=Object.create(a,{name:{value:"EnvelopeFollower"},defaults:{value:{attackTime:{value:.003,min:0,max:.5,automatable:!1,type:f},releaseTime:{value:.5,min:0,max:.5,automatable:!1,type:f}}},buffersize:{value:256},envelope:{value:0},sampleRate:{value:44100},attackTime:{enumerable:!0,get:function(){return this._attackTime},set:function(e){this._attackTime=e,this._attackC=Math.exp(-1/this._attackTime*this.sampleRate/this.buffersize)}},releaseTime:{enumerable:!0,get:function(){return this._releaseTime},set:function(e){this._releaseTime=e,this._releaseC=Math.exp(-1/this._releaseTime*this.sampleRate/this.buffersize)}},callback:{get:function(){return this._callback},set:function(e){typeof e=="function"?this._callback=e:console.error("tuna.js: "+this.name+": Callback must be a function!")}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){this.activated=e,e?(this.jsNode.connect(t.destination),this.jsNode.onaudioprocess=this.returnCompute(this)):(this.jsNode.disconnect(),this.jsNode.onaudioprocess=null)}},returnCompute:{value:function(e){return function(t){e.compute(t)}}},compute:{value:function(e){var t=e.inputBuffer.getChannelData(0).length,n=e.inputBuffer.numberOfChannels,r,i,s,o;i=s=o=0;if(n>1)for(o=0;o<t;++o)for(;i<n;++i)r=e.inputBuffer.getChannelData(i)[o],s+=r*r/n;else for(o=0;o<t;++o)r=e.inputBuffer.getChannelData(0)[o],s+=r*r;s=Math.sqrt(s),this._envelope<s?(this._envelope*=this._attackC,this._envelope+=(1-this._attackC)*s):(this._envelope*=this._releaseC,this._envelope+=(1-this._releaseC)*s),this._callback(this._target,this._envelope)}}}),r.prototype.LFO=function(e){this.output=t.createJavaScriptNode(256,1,1),this.activateNode=t.destination,this.frequency=e.frequency||this.defaults.frequency.value,this.offset=e.offset||this.defaults.offset.value,this.oscillation=e.oscillation||this.defaults.oscillation.value,this.phase=e.phase||this.defaults.phase.value,this.target=e.target||{},this.output.onaudioprocess=this.callback(e.callback||function(){}),this.bypass=!1},r.prototype.LFO.prototype=Object.create(a,{name:{value:"LFO"},bufferSize:{value:256},sampleRate:{value:44100},defaults:{value:{frequency:{value:1,min:0,max:20,automatable:!1,type:f},offset:{value:.85,min:0,max:22049,automatable:!1,type:f},oscillation:{value:.3,min:-22050,max:22050,automatable:!1,type:f},phase:{value:0,min:0,max:2*Math.PI,automatable:!1,type:f}}},frequency:{get:function(){return this._frequency},set:function(e){this._frequency=e,this._phaseInc=2*Math.PI*this._frequency*this.bufferSize/this.sampleRate}},offset:{get:function(){return this._offset},set:function(e){this._offset=e}},oscillation:{get:function(){return this._oscillation},set:function(e){this._oscillation=e}},phase:{get:function(){return this._phase},set:function(e){this._phase=e}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){e?this.output.connect(t.destination):this.output.disconnect(t.destination)}},callback:{value:function(e){var t=this;return function(){t._phase+=t._phaseInc,t._phase>2*Math.PI&&(t._phase=0),e(t._target,t._offset+t._oscillation*Math.sin(t._phase))}}}}),r.toString=r.prototype.toString=function(){return"You are running Tuna version "+i+" by Dinahmoe!"},typeof define=="function"?define("Tuna",[],function(){return r}):e.Tuna=r})(this);