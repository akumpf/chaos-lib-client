/* 
 *  DSP.js - a comprehensive digital signal processing  library for javascript
 * 
 *  Created by Corban Brook <corbanbrook@gmail.com> on 2010-01-01.
 *  Copyright 2010 Corban Brook. All rights reserved.
 *
 */////////////////////////////////////////////////////////////////////////////////
//                                  CONSTANTS                                 //
////////////////////////////////////////////////////////////////////////////////
/**
 * DSP is an object which contains general purpose utility functions and constants
 */function setupTypedArray(e,t){typeof this[e]!="function"&&typeof this[e]!="object"&&(typeof this[t]=="function"&&typeof this[t]!="object"?this[e]=this[t]:this[e]=function(e){if(e instanceof Array)return e;if(typeof e=="number")return new Array(e)})}function FourierTransform(e,t){this.bufferSize=e,this.sampleRate=t,this.bandwidth=2/e*t/2,this.spectrum=new Float32Array(e/2),this.real=new Float32Array(e),this.imag=new Float32Array(e),this.peakBand=0,this.peak=0,this.getBandFrequency=function(e){return this.bandwidth*e+this.bandwidth/2},this.calculateSpectrum=function(){var t=this.spectrum,n=this.real,r=this.imag,i=2/this.bufferSize,s=Math.sqrt,o,u,a;for(var f=0,l=e/2;f<l;f++)o=n[f],u=r[f],a=i*s(o*o+u*u),a>this.peak&&(this.peakBand=f,this.peak=a),t[f]=a}}function DFT(e,t){FourierTransform.call(this,e,t);var n=e/2*e,r=2*Math.PI;this.sinTable=new Float32Array(n),this.cosTable=new Float32Array(n);for(var i=0;i<n;i++)this.sinTable[i]=Math.sin(i*r/e),this.cosTable[i]=Math.cos(i*r/e)}function FFT(e,t){FourierTransform.call(this,e,t),this.reverseTable=new Uint32Array(e);var n=1,r=e>>1,i;while(n<e){for(i=0;i<n;i++)this.reverseTable[i+n]=this.reverseTable[i]+r;n<<=1,r>>=1}this.sinTable=new Float32Array(e),this.cosTable=new Float32Array(e);for(i=0;i<e;i++)this.sinTable[i]=Math.sin(-Math.PI/i),this.cosTable[i]=Math.cos(-Math.PI/i)}function RFFT(e,t){FourierTransform.call(this,e,t),this.trans=new Float32Array(e),this.reverseTable=new Uint32Array(e),this.reverseBinPermute=function(e,t){var n=this.bufferSize,r=n>>>1,i=n-1,s=1,o=0,u;e[0]=t[0];do{o+=r,e[s]=t[o],e[o]=t[s],s++,u=r<<1;while(u>>=1,!((o^=u)&u));o>=s&&(e[s]=t[o],e[o]=t[s],e[i-s]=t[i-o],e[i-o]=t[i-s]),s++}while(s<r);e[i]=t[i]},this.generateReverseTable=function(){var e=this.bufferSize,t=e>>>1,n=e-1,r=1,i=0,s;this.reverseTable[0]=0;do{i+=t,this.reverseTable[r]=i,this.reverseTable[i]=r,r++,s=t<<1;while(s>>=1,!((i^=s)&s));i>=r&&(this.reverseTable[r]=i,this.reverseTable[i]=r,this.reverseTable[n-r]=n-i,this.reverseTable[n-i]=n-r),r++}while(r<t);this.reverseTable[n]=n},this.generateReverseTable()}function Sampler(e,t,n,r,i,s,o,u){this.file=e,this.bufferSize=t,this.sampleRate=n,this.playStart=r||0,this.playEnd=i||1,this.loopStart=s||0,this.loopEnd=o||1,this.loopMode=u||DSP.OFF,this.loaded=!1,this.samples=[],this.signal=new Float32Array(t),this.frameCount=0,this.envelope=null,this.amplitude=1,this.rootFrequency=110,this.frequency=550,this.step=this.frequency/this.rootFrequency,this.duration=0,this.samplesProcessed=0,this.playhead=0;var a=document.createElement("AUDIO"),f=this;this.loadSamples=function(e){var t=DSP.getChannel(DSP.MIX,e.frameBuffer);for(var n=0;n<t.length;n++)f.samples.push(t[n])},this.loadComplete=function(){f.samples=new Float32Array(f.samples),f.loaded=!0},this.loadMetaData=function(){f.duration=a.duration},a.addEventListener("MozAudioAvailable",this.loadSamples,!1),a.addEventListener("loadedmetadata",this.loadMetaData,!1),a.addEventListener("ended",this.loadComplete,!1),a.muted=!0,a.src=e,a.play()}function Oscillator(e,t,n,r,i){this.frequency=t,this.amplitude=n,this.bufferSize=r,this.sampleRate=i,this.frameCount=0,this.waveTableLength=2048,this.cyclesPerSample=t/i,this.signal=new Float32Array(r),this.envelope=null;switch(parseInt(e,10)){case DSP.TRIANGLE:this.func=Oscillator.Triangle;break;case DSP.SAW:this.func=Oscillator.Saw;break;case DSP.SQUARE:this.func=Oscillator.Square;break;default:case DSP.SINE:this.func=Oscillator.Sine}this.generateWaveTable=function(){Oscillator.waveTable[this.func]=new Float32Array(2048);var e=this.waveTableLength/this.sampleRate,t=1/e;for(var n=0;n<this.waveTableLength;n++)Oscillator.waveTable[this.func][n]=this.func(n*t/this.sampleRate)},typeof Oscillator.waveTable=="undefined"&&(Oscillator.waveTable={}),typeof Oscillator.waveTable[this.func]=="undefined"&&this.generateWaveTable(),this.waveTable=Oscillator.waveTable[this.func]}function ADSR(e,t,n,r,i,s){this.sampleRate=s,this.attackLength=e,this.decayLength=t,this.sustainLevel=n,this.sustainLength=r,this.releaseLength=i,this.sampleRate=s,this.attackSamples=e*s,this.decaySamples=t*s,this.sustainSamples=r*s,this.releaseSamples=i*s,this.update=function(){this.attack=this.attackSamples,this.decay=this.attack+this.decaySamples,this.sustain=this.decay+this.sustainSamples,this.release=this.sustain+this.releaseSamples},this.update(),this.samplesProcessed=0}function IIRFilter(e,t,n,r){this.sampleRate=r;switch(e){case DSP.LOWPASS:case DSP.LP12:this.func=new IIRFilter.LP12(t,n,r)}}function IIRFilter2(e,t,n,r){this.type=e,this.cutoff=t,this.resonance=n,this.sampleRate=r,this.f=Float32Array(4),this.f[0]=0,this.f[1]=0,this.f[2]=0,this.f[3]=0,this.calcCoeff=function(e,t){this.freq=2*Math.sin(Math.PI*Math.min(.25,e/(this.sampleRate*2))),this.damp=Math.min(2*(1-Math.pow(t,.25)),Math.min(2,2/this.freq-this.freq*.5))},this.calcCoeff(t,n)}function WindowFunction(e,t){this.alpha=t;switch(e){case DSP.BARTLETT:this.func=WindowFunction.Bartlett;break;case DSP.BARTLETTHANN:this.func=WindowFunction.BartlettHann;break;case DSP.BLACKMAN:this.func=WindowFunction.Blackman,this.alpha=this.alpha||.16;break;case DSP.COSINE:this.func=WindowFunction.Cosine;break;case DSP.GAUSS:this.func=WindowFunction.Gauss,this.alpha=this.alpha||.25;break;case DSP.HAMMING:this.func=WindowFunction.Hamming;break;case DSP.HANN:this.func=WindowFunction.Hann;break;case DSP.LANCZOS:this.func=WindowFunction.Lanczoz;break;case DSP.RECTANGULAR:this.func=WindowFunction.Rectangular;break;case DSP.TRIANGULAR:this.func=WindowFunction.Triangular}}function sinh(e){return(Math.exp(e)-Math.exp(-e))/2}function Biquad(e,t){this.Fs=t,this.type=e,this.parameterType=DSP.Q,this.x_1_l=0,this.x_2_l=0,this.y_1_l=0,this.y_2_l=0,this.x_1_r=0,this.x_2_r=0,this.y_1_r=0,this.y_2_r=0,this.b0=1,this.a0=1,this.b1=0,this.a1=0,this.b2=0,this.a2=0,this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0,this.f0=3e3,this.dBgain=12,this.Q=1,this.BW=-3,this.S=1,this.coefficients=function(){var e=[this.b0,this.b1,this.b2],t=[this.a0,this.a1,this.a2];return{b:e,a:t}},this.setFilterType=function(e){this.type=e,this.recalculateCoefficients()},this.setSampleRate=function(e){this.Fs=e,this.recalculateCoefficients()},this.setQ=function(e){this.parameterType=DSP.Q,this.Q=Math.max(Math.min(e,115),.001),this.recalculateCoefficients()},this.setBW=function(e){this.parameterType=DSP.BW,this.BW=e,this.recalculateCoefficients()},this.setS=function(e){this.parameterType=DSP.S,this.S=Math.max(Math.min(e,5),1e-4),this.recalculateCoefficients()},this.setF0=function(e){this.f0=e,this.recalculateCoefficients()},this.setDbGain=function(e){this.dBgain=e,this.recalculateCoefficients()},this.recalculateCoefficients=function(){var t;e===DSP.PEAKING_EQ||e===DSP.LOW_SHELF||e===DSP.HIGH_SHELF?t=Math.pow(10,this.dBgain/40):t=Math.sqrt(Math.pow(10,this.dBgain/20));var n=DSP.TWO_PI*this.f0/this.Fs,r=Math.cos(n),i=Math.sin(n),s=0;switch(this.parameterType){case DSP.Q:s=i/(2*this.Q);break;case DSP.BW:s=i*sinh(Math.LN2/2*this.BW*n/i);break;case DSP.S:s=i/2*Math.sqrt((t+1/t)*(1/this.S-1)+2)}var o;switch(this.type){case DSP.LPF:this.b0=(1-r)/2,this.b1=1-r,this.b2=(1-r)/2,this.a0=1+s,this.a1=-2*r,this.a2=1-s;break;case DSP.HPF:this.b0=(1+r)/2,this.b1=-(1+r),this.b2=(1+r)/2,this.a0=1+s,this.a1=-2*r,this.a2=1-s;break;case DSP.BPF_CONSTANT_SKIRT:this.b0=i/2,this.b1=0,this.b2=-i/2,this.a0=1+s,this.a1=-2*r,this.a2=1-s;break;case DSP.BPF_CONSTANT_PEAK:this.b0=s,this.b1=0,this.b2=-s,this.a0=1+s,this.a1=-2*r,this.a2=1-s;break;case DSP.NOTCH:this.b0=1,this.b1=-2*r,this.b2=1,this.a0=1+s,this.a1=-2*r,this.a2=1-s;break;case DSP.APF:this.b0=1-s,this.b1=-2*r,this.b2=1+s,this.a0=1+s,this.a1=-2*r,this.a2=1-s;break;case DSP.PEAKING_EQ:this.b0=1+s*t,this.b1=-2*r,this.b2=1-s*t,this.a0=1+s/t,this.a1=-2*r,this.a2=1-s/t;break;case DSP.LOW_SHELF:o=i*Math.sqrt((t^3)*(1/this.S-1)+2*t),this.b0=t*(t+1-(t-1)*r+o),this.b1=2*t*(t-1-(t+1)*r),this.b2=t*(t+1-(t-1)*r-o),this.a0=t+1+(t-1)*r+o,this.a1=-2*(t-1+(t+1)*r),this.a2=t+1+(t-1)*r-o;break;case DSP.HIGH_SHELF:o=i*Math.sqrt((t^3)*(1/this.S-1)+2*t),this.b0=t*(t+1+(t-1)*r+o),this.b1=-2*t*(t-1+(t+1)*r),this.b2=t*(t+1+(t-1)*r-o),this.a0=t+1-(t-1)*r+o,this.a1=2*(t-1-(t+1)*r),this.a2=t+1-(t-1)*r-o}this.b0a0=this.b0/this.a0,this.b1a0=this.b1/this.a0,this.b2a0=this.b2/this.a0,this.a1a0=this.a1/this.a0,this.a2a0=this.a2/this.a0},this.process=function(e){var t=e.length,n=new Float32Array(t);for(var r=0;r<e.length;r++)n[r]=this.b0a0*e[r]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=n[r],this.x_2_l=this.x_1_l,this.x_1_l=e[r];return n},this.processStereo=function(e){var t=e.length,n=new Float32Array(t);for(var r=0;r<t/2;r++)n[2*r]=this.b0a0*e[2*r]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l,this.y_2_l=this.y_1_l,this.y_1_l=n[2*r],this.x_2_l=this.x_1_l,this.x_1_l=e[2*r],n[2*r+1]=this.b0a0*e[2*r+1]+this.b1a0*this.x_1_r+this.b2a0*this.x_2_r-this.a1a0*this.y_1_r-this.a2a0*this.y_2_r,this.y_2_r=this.y_1_r,this.y_1_r=n[2*r+1],this.x_2_r=this.x_1_r,this.x_1_r=e[2*r+1];return n}}function GraphicalEq(e){this.FS=e,this.minFreq=40,this.maxFreq=16e3,this.bandsPerOctave=1,this.filters=[],this.freqzs=[],this.calculateFreqzs=!0,this.recalculateFilters=function(){var e=Math.round(Math.log(this.maxFreq/this.minFreq)*this.bandsPerOctave/Math.LN2);this.filters=[];for(var t=0;t<e;t++){var n=this.minFreq*Math.pow(2,t/this.bandsPerOctave),r=new Biquad(DSP.PEAKING_EQ,this.FS);r.setDbGain(0),r.setBW(1/this.bandsPerOctave),r.setF0(n),this.filters[t]=r,this.recalculateFreqz(t)}},this.setMinimumFrequency=function(e){this.minFreq=e,this.recalculateFilters()},this.setMaximumFrequency=function(e){this.maxFreq=e,this.recalculateFilters()},this.setBandsPerOctave=function(e){this.bandsPerOctave=e,this.recalculateFilters()},this.setBandGain=function(e,t){if(e<0||e>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds.";if(!t)throw"A gain must be passed.";this.filters[e].setDbGain(t),this.recalculateFreqz(e)},this.recalculateFreqz=function(e){if(!this.calculateFreqzs)return;if(e<0||e>this.filters.length-1)throw"The band index of the graphical equalizer is out of bounds. "+e+" is out of ["+0+", "+this.filters.length-1+"]";if(!this.w){this.w=Float32Array(400);for(var t=0;t<this.w.length;t++)this.w[t]=Math.PI/this.w.length*t}var n=[this.filters[e].b0,this.filters[e].b1,this.filters[e].b2],r=[this.filters[e].a0,this.filters[e].a1,this.filters[e].a2];this.freqzs[e]=DSP.mag2db(DSP.freqz(n,r,this.w))},this.process=function(e){var t=e;for(var n=0;n<this.filters.length;n++)t=this.filters[n].process(t);return t},this.processStereo=function(e){var t=e;for(var n=0;n<this.filters.length;n++)t=this.filters[n].processStereo(t);return t}}function MultiDelay(e,t,n,r){this.delayBufferSamples=new Float32Array(e),this.delayInputPointer=t,this.delayOutputPointer=0,this.delayInSamples=t,this.masterVolume=n,this.delayVolume=r}function SingleDelay(e,t,n){this.delayBufferSamples=new Float32Array(e),this.delayInputPointer=t,this.delayOutputPointer=0,this.delayInSamples=t,this.delayVolume=n}function Reverb(e,t,n,r,i,s){this.delayInSamples=t,this.masterVolume=n,this.mixVolume=r,this.delayVolume=i,this.dampFrequency=s,this.NR_OF_MULTIDELAYS=6,this.NR_OF_SINGLEDELAYS=6,this.LOWPASSL=new IIRFilter2(DSP.LOWPASS,s,0,44100),this.LOWPASSR=new IIRFilter2(DSP.LOWPASS,s,0,44100),this.singleDelays=[];var o,u;for(o=0;o<this.NR_OF_SINGLEDELAYS;o++)u=1+o/7,this.singleDelays[o]=new SingleDelay(e,Math.round(this.delayInSamples*u),this.delayVolume);this.multiDelays=[];for(o=0;o<this.NR_OF_MULTIDELAYS;o++)u=1+o/10,this.multiDelays[o]=new MultiDelay(e,Math.round(this.delayInSamples*u),this.masterVolume,this.delayVolume)}var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};setupTypedArray("Float32Array","WebGLFloatArray"),setupTypedArray("Int32Array","WebGLIntArray"),setupTypedArray("Uint16Array","WebGLUnsignedShortArray"),setupTypedArray("Uint8Array","WebGLUnsignedByteArray"),DSP.invert=function(e){for(var t=0,n=e.length;t<n;t++)e[t]*=-1;return e},DSP.interleave=function(e,t){if(e.length!==t.length)throw"Can not interleave. Channel lengths differ.";var n=new Float32Array(e.length*2);for(var r=0,i=e.length;r<i;r++)n[2*r]=e[r],n[2*r+1]=t[r];return n},DSP.deinterleave=function(){var e,t,n,r=[];return r[DSP.MIX]=function(e){for(var t=0,r=e.length/2;t<r;t++)n[t]=(e[2*t]+e[2*t+1])/2;return n},r[DSP.LEFT]=function(t){for(var n=0,r=t.length/2;n<r;n++)e[n]=t[2*n];return e},r[DSP.RIGHT]=function(e){for(var n=0,r=e.length/2;n<r;n++)t[n]=e[2*n+1];return t},function(i,s){return e=e||new Float32Array(s.length/2),t=t||new Float32Array(s.length/2),n=n||new Float32Array(s.length/2),s.length/2!==e.length&&(e=new Float32Array(s.length/2),t=new Float32Array(s.length/2),n=new Float32Array(s.length/2)),r[i](s)}}(),DSP.getChannel=DSP.deinterleave,DSP.mixSampleBuffers=function(e,t,n,r){var i=new Float32Array(e);for(var s=0;s<e.length;s++)i[s]+=(n?-t[s]:t[s])/r;return i},DSP.LPF=0,DSP.HPF=1,DSP.BPF_CONSTANT_SKIRT=2,DSP.BPF_CONSTANT_PEAK=3,DSP.NOTCH=4,DSP.APF=5,DSP.PEAKING_EQ=6,DSP.LOW_SHELF=7,DSP.HIGH_SHELF=8,DSP.Q=1,DSP.BW=2,DSP.S=3,DSP.RMS=function(e){var t=0;for(var n=0,r=e.length;n<r;n++)t+=e[n]*e[n];return Math.sqrt(t/r)},DSP.Peak=function(e){var t=0;for(var n=0,r=e.length;n<r;n++)t=Math.abs(e[n])>t?Math.abs(e[n]):t;return t},DFT.prototype.forward=function(e){var t=this.real,n=this.imag,r,i;for(var s=0;s<this.bufferSize/2;s++){r=0,i=0;for(var o=0;o<e.length;o++)r+=this.cosTable[s*o]*e[o],i+=this.sinTable[s*o]*e[o];t[s]=r,n[s]=i}return this.calculateSpectrum()},FFT.prototype.forward=function(e){var t=this.bufferSize,n=this.cosTable,r=this.sinTable,i=this.reverseTable,s=this.real,o=this.imag,u=this.spectrum,a=Math.floor(Math.log(t)/Math.LN2);if(Math.pow(2,a)!==t)throw"Invalid buffer size, must be a power of 2.";if(t!==e.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+t+" Buffer Size: "+e.length;var f=1,l,c,h,p,d,v,m,g,y;for(y=0;y<t;y++)s[y]=e[i[y]],o[y]=0;while(f<t){l=n[f],c=r[f],h=1,p=0;for(var b=0;b<f;b++){y=b;while(y<t)d=y+f,v=h*s[d]-p*o[d],m=h*o[d]+p*s[d],s[d]=s[y]-v,o[d]=o[y]-m,s[y]+=v,o[y]+=m,y+=f<<1;g=h,h=g*l-p*c,p=g*c+p*l}f<<=1}return this.calculateSpectrum()},FFT.prototype.inverse=function(e,t){var n=this.bufferSize,r=this.cosTable,i=this.sinTable,s=this.reverseTable,o=this.spectrum;e=e||this.real,t=t||this.imag;var u=1,a,f,l,c,h,p,d,v,m;for(m=0;m<n;m++)t[m]*=-1;var g=new Float32Array(n),y=new Float32Array(n);for(m=0;m<e.length;m++)g[m]=e[s[m]],y[m]=t[s[m]];e=g,t=y;while(u<n){a=r[u],f=i[u],l=1,c=0;for(var b=0;b<u;b++){m=b;while(m<n)h=m+u,p=l*e[h]-c*t[h],d=l*t[h]+c*e[h],e[h]=e[m]-p,t[h]=t[m]-d,e[m]+=p,t[m]+=d,m+=u<<1;v=l,l=v*a-c*f,c=v*f+c*a}u<<=1}var w=new Float32Array(n);for(m=0;m<n;m++)w[m]=e[m]/n;return w},RFFT.prototype.forward=function(e){var t=this.bufferSize,n=this.spectrum,r=this.trans,i=2*Math.PI,s=Math.sqrt,o=t>>>1,u=2/t,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D;this.reverseBinPermute(r,e);for(var P=0,H=4;P<t;H*=4){for(var B=P;B<t;B+=H)T=r[B]-r[B+1],r[B]+=r[B+1],r[B+1]=T;P=2*(H-1)}a=2,c=t>>>1;while(c>>>=1){P=0,a<<=1,H=a<<1,f=a>>>2,l=a>>>3;do{if(f!==1)for(B=P;B<t;B+=H)m=B,g=m+f,y=g+f,b=y+f,h=r[y]+r[b],r[b]-=r[y],r[y]=r[m]-h,r[m]+=h,m+=l,g+=l,y+=l,b+=l,h=r[y]+r[b],p=r[y]-r[b],h=-h*Math.SQRT1_2,p*=Math.SQRT1_2,T=r[g],r[b]=h+T,r[y]=h-T,r[g]=r[m]-p,r[m]+=p;else for(B=P;B<t;B+=H)m=B,g=m+f,y=g+f,b=y+f,h=r[y]+r[b],r[b]-=r[y],r[y]=r[m]-h,r[m]+=h;P=(H<<1)-a,H<<=2}while(P<t);A=i/a;for(var j=1;j<l;j++){O=j*A,C=Math.sin(O),N=Math.cos(O),k=4*N*(N*N-.75),L=4*C*(.75-C*C),P=0,H=a<<1;do{for(B=P;B<t;B+=H)m=B+j,g=m+f,y=g+f,b=y+f,w=B+f-j,E=w+f,S=E+f,x=S+f,p=r[S]*N-r[y]*C,h=r[S]*C+r[y]*N,v=r[x]*k-r[b]*L,d=r[x]*L+r[b]*k,T=p-v,p+=v,v=T,r[x]=p+r[E],r[y]=p-r[E],T=d-h,h+=d,d=T,r[b]=d+r[g],r[S]=d-r[g],r[E]=r[m]-h,r[m]+=h,r[g]=v+r[w],r[w]-=v;P=(H<<1)-a,H<<=2}while(P<t)}}while(--o)M=r[o],_=r[t-o-1],D=u*s(M*M+_*_),D>this.peak&&(this.peakBand=o,this.peak=D),n[o]=D;return n[0]=u*r[0],n},Sampler.prototype.applyEnvelope=function(){return this.envelope.process(this.signal),this.signal},Sampler.prototype.generate=function(){var e=this.frameCount*this.bufferSize,t=this.playEnd*this.samples.length-this.playStart*this.samples.length,n=this.playStart*this.samples.length,r=this.playEnd*this.samples.length,i;for(var s=0;s<this.bufferSize;s++){switch(this.loopMode){case DSP.OFF:this.playhead=Math.round(this.samplesProcessed*this.step+n),this.playhead<this.playEnd*this.samples.length?this.signal[s]=this.samples[this.playhead]*this.amplitude:this.signal[s]=0;break;case DSP.FW:this.playhead=Math.round(this.samplesProcessed*this.step%t+n),this.playhead<this.playEnd*this.samples.length&&(this.signal[s]=this.samples[this.playhead]*this.amplitude);break;case DSP.BW:this.playhead=r-Math.round(this.samplesProcessed*this.step%t),this.playhead<this.playEnd*this.samples.length&&(this.signal[s]=this.samples[this.playhead]*this.amplitude);break;case DSP.FWBW:Math.floor(this.samplesProcessed*this.step/t)%2===0?this.playhead=Math.round(this.samplesProcessed*this.step%t+n):this.playhead=r-Math.round(this.samplesProcessed*this.step%t),this.playhead<this.playEnd*this.samples.length&&(this.signal[s]=this.samples[this.playhead]*this.amplitude)}this.samplesProcessed++}return this.frameCount++,this.signal},Sampler.prototype.setFreq=function(e){var t=this.samplesProcessed*this.step;this.frequency=e,this.step=this.frequency/this.rootFrequency,this.samplesProcessed=Math.round(t/this.step)},Sampler.prototype.reset=function(){this.samplesProcessed=0,this.playhead=0},Oscillator.prototype.setAmp=function(e){if(!(e>=0&&e<=1))throw"Amplitude out of range (0..1).";this.amplitude=e},Oscillator.prototype.setFreq=function(e){this.frequency=e,this.cyclesPerSample=e/this.sampleRate},Oscillator.prototype.add=function(e){for(var t=0;t<this.bufferSize;t++)this.signal[t]+=e.signal[t];return this.signal},Oscillator.prototype.addSignal=function(e){for(var t=0;t<e.length;t++){if(t>=this.bufferSize)break;this.signal[t]+=e[t]}return this.signal},Oscillator.prototype.addEnvelope=function(e){this.envelope=e},Oscillator.prototype.applyEnvelope=function(){this.envelope.process(this.signal)},Oscillator.prototype.valueAt=function(e){return this.waveTable[e%this.waveTableLength]},Oscillator.prototype.generate=function(){var e=this.frameCount*this.bufferSize,t=this.waveTableLength*this.frequency/this.sampleRate,n;for(var r=0;r<this.bufferSize;r++)n=Math.round((e+r)*t),this.signal[r]=this.waveTable[n%this.waveTableLength]*this.amplitude;return this.frameCount++,this.signal},Oscillator.Sine=function(e){return Math.sin(DSP.TWO_PI*e)},Oscillator.Square=function(e){return e<.5?1:-1},Oscillator.Saw=function(e){return 2*(e-Math.round(e))},Oscillator.Triangle=function(e){return 1-4*Math.abs(Math.round(e)-e)},Oscillator.Pulse=function(e){},ADSR.prototype.noteOn=function(){this.samplesProcessed=0,this.sustainSamples=this.sustainLength*this.sampleRate,this.update()},ADSR.prototype.noteOff=function(){this.sustainSamples=this.samplesProcessed-this.decaySamples,this.update()},ADSR.prototype.processSample=function(e){var t=0;return this.samplesProcessed<=this.attack?t=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?t=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?t=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(t=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))),e*t},ADSR.prototype.value=function(){var e=0;return this.samplesProcessed<=this.attack?e=0+1*((this.samplesProcessed-0)/(this.attack-0)):this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay?e=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack)):this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain?e=this.sustainLevel:this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release&&(e=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain))),e},ADSR.prototype.process=function(e){for(var t=0;t<e.length;t++)e[t]*=this.value(),this.samplesProcessed++;return e},ADSR.prototype.isActive=function(){return this.samplesProcessed>this.release||this.samplesProcessed===-1?!1:!0},ADSR.prototype.disable=function(){this.samplesProcessed=-1},IIRFilter.prototype.__defineGetter__("cutoff",function(){return this.func.cutoff}),IIRFilter.prototype.__defineGetter__("resonance",function(){return this.func.resonance}),IIRFilter.prototype.set=function(e,t){this.func.calcCoeff(e,t)},IIRFilter.prototype.process=function(e){this.func.process(e)},IIRFilter.prototype.addEnvelope=function(e){if(!(e instanceof ADSR))throw"Not an envelope.";this.func.addEnvelope(e)},IIRFilter.LP12=function(e,t,n){this.sampleRate=n,this.vibraPos=0,this.vibraSpeed=0,this.envelope=!1,this.calcCoeff=function(e,t){this.w=2*Math.PI*e/this.sampleRate,this.q=1-this.w/(2*(t+.5/(1+this.w))+this.w-2),this.r=this.q*this.q,this.c=this.r+1-2*Math.cos(this.w)*this.q,this.cutoff=e,this.resonance=t},this.calcCoeff(e,t),this.process=function(e){for(var t=0;t<e.length;t++)this.vibraSpeed+=(e[t]-this.vibraPos)*this.c,this.vibraPos+=this.vibraSpeed,this.vibraSpeed*=this.r,this.envelope?(e[t]=e[t]*(1-this.envelope.value())+this.vibraPos*this.envelope.value(),this.envelope.samplesProcessed++):e[t]=this.vibraPos}},IIRFilter.LP12.prototype.addEnvelope=function(e){this.envelope=e},IIRFilter2.prototype.process=function(e){var t,n,r=this.f;for(var i=0;i<e.length;i++)t=e[i],r[3]=t-this.damp*r[2],r[0]=r[0]+this.freq*r[2],r[1]=r[3]-r[0],r[2]=this.freq*r[1]+r[2],n=.5*r[this.type],r[3]=t-this.damp*r[2],r[0]=r[0]+this.freq*r[2],r[1]=r[3]-r[0],r[2]=this.freq*r[1]+r[2],n+=.5*r[this.type],this.envelope?(e[i]=e[i]*(1-this.envelope.value())+n*this.envelope.value(),this.envelope.samplesProcessed++):e[i]=n},IIRFilter2.prototype.addEnvelope=function(e){if(!(e instanceof ADSR))throw"This is not an envelope.";this.envelope=e},IIRFilter2.prototype.set=function(e,t){this.calcCoeff(e,t)},WindowFunction.prototype.process=function(e){var t=e.length;for(var n=0;n<t;n++)e[n]*=this.func(t,n,this.alpha);return e},WindowFunction.Bartlett=function(e,t){return 2/(e-1)*((e-1)/2-Math.abs(t-(e-1)/2))},WindowFunction.BartlettHann=function(e,t){return.62-.48*Math.abs(t/(e-1)-.5)-.38*Math.cos(DSP.TWO_PI*t/(e-1))},WindowFunction.Blackman=function(e,t,n){var r=(1-n)/2,i=.5,s=n/2;return r-i*Math.cos(DSP.TWO_PI*t/(e-1))+s*Math.cos(4*Math.PI*t/(e-1))},WindowFunction.Cosine=function(e,t){return Math.cos(Math.PI*t/(e-1)-Math.PI/2)},WindowFunction.Gauss=function(e,t,n){return Math.pow(Math.E,-0.5*Math.pow((t-(e-1)/2)/(n*(e-1)/2),2))},WindowFunction.Hamming=function(e,t){return.54-.46*Math.cos(DSP.TWO_PI*t/(e-1))},WindowFunction.Hann=function(e,t){return.5*(1-Math.cos(DSP.TWO_PI*t/(e-1)))},WindowFunction.Lanczos=function(e,t){var n=2*t/(e-1)-1;return Math.sin(Math.PI*n)/(Math.PI*n)},WindowFunction.Rectangular=function(e,t){return 1},WindowFunction.Triangular=function(e,t){return 2/e*(e/2-Math.abs(t-(e-1)/2))},DSP.mag2db=function(e){var t=-120,n=Math.pow(10,t/20),r=Math.log,i=Math.max,s=Float32Array(e.length);for(var o=0;o<e.length;o++)s[o]=20*r(i(e[o],n));return s},DSP.freqz=function(e,t,n){var r,i;if(!n){n=Float32Array(200);for(r=0;r<n.length;r++)n[r]=DSP.TWO_PI/n.length*r-Math.PI}var s=Float32Array(n.length),o=Math.sqrt,u=Math.cos,a=Math.sin;for(r=0;r<n.length;r++){var f={real:0,imag:0};for(i=0;i<e.length;i++)f.real+=e[i]*u(-i*n[r]),f.imag+=e[i]*a(-i*n[r]);var l={real:0,imag:0};for(i=0;i<t.length;i++)l.real+=t[i]*u(-i*n[r]),l.imag+=t[i]*a(-i*n[r]);s[r]=o(f.real*f.real+f.imag*f.imag)/o(l.real*l.real+l.imag*l.imag)}return s},MultiDelay.prototype.setDelayInSamples=function(e){this.delayInSamples=e,this.delayInputPointer=this.delayOutputPointer+e,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},MultiDelay.prototype.setMasterVolume=function(e){this.masterVolume=e},MultiDelay.prototype.setDelayVolume=function(e){this.delayVolume=e},MultiDelay.prototype.process=function(e){var t=new Float32Array(e.length);for(var n=0;n<e.length;n++){var r=this.delayBufferSamples[this.delayOutputPointer]===null?0:this.delayBufferSamples[this.delayOutputPointer],i=r*this.delayVolume+e[n];this.delayBufferSamples[this.delayInputPointer]=i,t[n]=i*this.masterVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0)}return t},SingleDelay.prototype.setDelayInSamples=function(e){this.delayInSamples=e,this.delayInputPointer=this.delayOutputPointer+e,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length)},SingleDelay.prototype.setDelayVolume=function(e){this.delayVolume=e},SingleDelay.prototype.process=function(e){var t=new Float32Array(e.length);for(var n=0;n<e.length;n++){this.delayBufferSamples[this.delayInputPointer]=e[n];var r=this.delayBufferSamples[this.delayOutputPointer];t[n]=r*this.delayVolume,this.delayInputPointer++,this.delayInputPointer>=this.delayBufferSamples.length-1&&(this.delayInputPointer=0),this.delayOutputPointer++,this.delayOutputPointer>=this.delayBufferSamples.length-1&&(this.delayOutputPointer=0)}return t},Reverb.prototype.setDelayInSamples=function(e){this.delayInSamples=e;var t,n;for(t=0;t<this.NR_OF_SINGLEDELAYS;t++)n=1+t/7,this.singleDelays[t].setDelayInSamples(Math.round(this.delayInSamples*n));for(t=0;t<this.NR_OF_MULTIDELAYS;t++)n=1+t/10,this.multiDelays[t].setDelayInSamples(Math.round(this.delayInSamples*n))},Reverb.prototype.setMasterVolume=function(e){this.masterVolume=e},Reverb.prototype.setMixVolume=function(e){this.mixVolume=e},Reverb.prototype.setDelayVolume=function(e){this.delayVolume=e;var t;for(t=0;t<this.NR_OF_SINGLEDELAYS;t++)this.singleDelays[t].setDelayVolume(this.delayVolume);for(t=0;t<this.NR_OF_MULTIDELAYS;t++)this.multiDelays[t].setDelayVolume(this.delayVolume)},Reverb.prototype.setDampFrequency=function(e){this.dampFrequency=e,this.LOWPASSL.set(e,0),this.LOWPASSR.set(e,0)},Reverb.prototype.process=function(e){var t=new Float32Array(e.length),n=DSP.deinterleave(e);this.LOWPASSL.process(n[DSP.LEFT]),this.LOWPASSR.process(n[DSP.RIGHT]);var r=DSP.interleave(n[DSP.LEFT],n[DSP.RIGHT]),i;for(i=0;i<this.NR_OF_MULTIDELAYS;i++)t=DSP.mixSampleBuffers(t,this.multiDelays[i].process(r),2%i===0,this.NR_OF_MULTIDELAYS);var s=new Float32Array(t.length);for(i=0;i<this.NR_OF_SINGLEDELAYS;i++)s=DSP.mixSampleBuffers(s,this.singleDelays[i].process(t),2%i===0,1);for(i=0;i<s.length;i++)s[i]*=this.mixVolume;t=DSP.mixSampleBuffers(s,e,0,1);for(i=0;i<t.length;i++)t[i]*=this.masterVolume;return t};
 
 define([],function(){return window.DSP});